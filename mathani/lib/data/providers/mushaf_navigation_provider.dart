import 'package:flutter/material.dart';
import '../models/mushaf_navigation_data.dart';
import '../services/shamarly_data_loader.dart';
import '../../presentation/providers/mushaf_metadata_provider.dart';

/// مزود بيانات التنقل الديناميكي لجميع المصاحف
class MushafNavigationProvider extends ChangeNotifier {
  MushafNavigationData? _currentNavigationData;
  String? _currentMushafId;
  bool _isLoading = false;

  MushafNavigationData? get currentNavigationData => _currentNavigationData;
  String? get currentMushafId => _currentMushafId;
  bool get isLoading => _isLoading;

  /// تحديث المصحف وتحميل بياناته
  Future<void> updateMushaf(String mushafId) async {
    if (_currentMushafId == mushafId && _currentNavigationData != null) {
      return; // البيانات محملة مسبقاً
    }

    _isLoading = true;
    _currentMushafId = mushafId;
    notifyListeners();

    try {
      if (mushafId == 'shamarly_15lines') {
        _currentNavigationData = await ShamarlyDataLoader.loadFromJson();
      } else {
        // مصحف المدينة (الافتراضي)
        _currentNavigationData = _loadMadaniData();
      }
    } catch (e) {
      debugPrint('خطأ في تحميل بيانات المصحف: $e');
      // fallback لمصحف المدينة
      _currentNavigationData = _loadMadaniData();
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  /// تحميل بيانات مصحف المدينة (604 صفحة)
  MushafNavigationData _loadMadaniData() {
    // خريطة السور إلى الصفحات (مصحف المدينة)
    const surahToPage = {
      1: 1, 2: 2, 3: 50, 4: 77, 5: 106, 6: 128, 7: 151, 8: 177, 9: 187, 10: 208,
      11: 221, 12: 235, 13: 249, 14: 255, 15: 262, 16: 267, 17: 282, 18: 293, 19: 305, 20: 312,
      21: 322, 22: 332, 23: 342, 24: 350, 25: 359, 26: 367, 27: 377, 28: 385, 29: 396, 30: 404,
      31: 411, 32: 415, 33: 418, 34: 428, 35: 434, 36: 440, 37: 446, 38: 453, 39: 458, 40: 467,
      41: 477, 42: 483, 43: 489, 44: 496, 45: 499, 46: 502, 47: 507, 48: 511, 49: 515, 50: 518,
      51: 520, 52: 523, 53: 526, 54: 528, 55: 531, 56: 534, 57: 537, 58: 542, 59: 545, 60: 549,
      61: 551, 62: 553, 63: 554, 64: 556, 65: 558, 66: 560, 67: 562, 68: 564, 69: 566, 70: 568,
      71: 570, 72: 572, 73: 574, 74: 575, 75: 577, 76: 578, 77: 580, 78: 582, 79: 583, 80: 585,
      81: 586, 82: 587, 83: 587, 84: 589, 85: 590, 86: 591, 87: 591, 88: 592, 89: 593, 90: 594,
      91: 595, 92: 595, 93: 596, 94: 596, 95: 597, 96: 597, 97: 598, 98: 598, 99: 599, 100: 599,
      101: 600, 102: 600, 103: 601, 104: 601, 105: 601, 106: 602, 107: 602, 108: 602, 109: 603, 110: 603,
      111: 603, 112: 604, 113: 604, 114: 604
    };

    // بيانات الأجزاء (مصحف المدينة)
    final juzData = {
      1: JuzInfo(number: 1, startPage: 1, startSurah: 1, startAyah: 1, surahName: 'الفاتحة'),
      2: JuzInfo(number: 2, startPage: 22, startSurah: 2, startAyah: 142, surahName: 'البقرة'),
      3: JuzInfo(number: 3, startPage: 42, startSurah: 2, startAyah: 253, surahName: 'البقرة'),
      4: JuzInfo(number: 4, startPage: 62, startSurah: 3, startAyah: 93, surahName: 'آل عمران'),
      5: JuzInfo(number: 5, startPage: 82, startSurah: 4, startAyah: 24, surahName: 'النساء'),
      6: JuzInfo(number: 6, startPage: 102, startSurah: 4, startAyah: 148, surahName: 'النساء'),
      7: JuzInfo(number: 7, startPage: 122, startSurah: 5, startAyah: 82, surahName: 'المائدة'),
      8: JuzInfo(number: 8, startPage: 142, startSurah: 6, startAyah: 111, surahName: 'الأنعام'),
      9: JuzInfo(number: 9, startPage: 162, startSurah: 7, startAyah: 88, surahName: 'الأعراف'),
      10: JuzInfo(number: 10, startPage: 182, startSurah: 8, startAyah: 41, surahName: 'الأنفال'),
      11: JuzInfo(number: 11, startPage: 202, startSurah: 9, startAyah: 93, surahName: 'التوبة'),
      12: JuzInfo(number: 12, startPage: 222, startSurah: 11, startAyah: 6, surahName: 'هود'),
      13: JuzInfo(number: 13, startPage: 242, startSurah: 12, startAyah: 53, surahName: 'يوسف'),
      14: JuzInfo(number: 14, startPage: 262, startSurah: 15, startAyah: 1, surahName: 'الحجر'),
      15: JuzInfo(number: 15, startPage: 282, startSurah: 17, startAyah: 1, surahName: 'الإسراء'),
      16: JuzInfo(number: 16, startPage: 302, startSurah: 18, startAyah: 75, surahName: 'الكهف'),
      17: JuzInfo(number: 17, startPage: 322, startSurah: 21, startAyah: 1, surahName: 'الأنبياء'),
      18: JuzInfo(number: 18, startPage: 342, startSurah: 23, startAyah: 1, surahName: 'المؤمنون'),
      19: JuzInfo(number: 19, startPage: 362, startSurah: 25, startAyah: 21, surahName: 'الفرقان'),
      20: JuzInfo(number: 20, startPage: 382, startSurah: 27, startAyah: 56, surahName: 'النمل'),
      21: JuzInfo(number: 21, startPage: 402, startSurah: 29, startAyah: 46, surahName: 'العنكبوت'),
      22: JuzInfo(number: 22, startPage: 422, startSurah: 33, startAyah: 31, surahName: 'الأحزاب'),
      23: JuzInfo(number: 23, startPage: 442, startSurah: 36, startAyah: 28, surahName: 'يس'),
      24: JuzInfo(number: 24, startPage: 462, startSurah: 39, startAyah: 32, surahName: 'الزمر'),
      25: JuzInfo(number: 25, startPage: 482, startSurah: 41, startAyah: 47, surahName: 'فصلت'),
      26: JuzInfo(number: 26, startPage: 502, startSurah: 46, startAyah: 1, surahName: 'الأحقاف'),
      27: JuzInfo(number: 27, startPage: 522, startSurah: 51, startAyah: 31, surahName: 'الذاريات'),
      28: JuzInfo(number: 28, startPage: 542, startSurah: 58, startAyah: 1, surahName: 'المجادلة'),
      29: JuzInfo(number: 29, startPage: 562, startSurah: 67, startAyah: 1, surahName: 'الملك'),
      30: JuzInfo(number: 30, startPage: 582, startSurah: 78, startAyah: 1, surahName: 'النبأ'),
    };

    // بيانات الصفحات مع أرقام السور
    final pageData = <int, PageInfo>{};
    for (int i = 1; i <= 604; i++) {
      // حساب الجزء من رقم الصفحة
      int juz = ((i - 1) ~/ 20) + 1;
      if (juz > 30) juz = 30;
      
      // إيجاد السور الموجودة في هذه الصفحة
      List<int> surahs = [];
      for (var entry in surahToPage.entries) {
        if (entry.value == i) {
          surahs.add(entry.key);
        }
      }
      // إذا لم نجد سورة تبدأ في هذه الصفحة، نجد السورة الحالية
      if (surahs.isEmpty) {
        for (var entry in surahToPage.entries.toList().reversed) {
          if (entry.value <= i) {
            surahs.add(entry.key);
            break;
          }
        }
      }
      
      // ★ الإصلاح الجذري: تعبئة startSurah من أول سورة في الصفحة
      final pageSurah = surahs.isNotEmpty ? surahs.first : 1;
      // إذا كانت هذه أول صفحة في السورة → startAyah = 1
      // وإلا → startAyah = 1 (تقريبي لعدم توفر بيانات أعمق)
      
      pageData[i] = PageInfo(
        page: i,
        juz: juz,
        hizb: ((i - 1) ~/ 10) + 1,
        quarter: ((i - 1) ~/ 5) + 1,
        surahs: surahs,
        startSurah: pageSurah,
        startAyah: 1,
        endSurah: surahs.isNotEmpty ? surahs.last : pageSurah,
        endAyah: 999, // سيتم تقليصه تلقائياً في AudioProvider
      );
    }

    return MushafNavigationData(
      mushafId: _currentMushafId ?? 'madani_font_v1',
      totalPages: 604,
      surahToPage: surahToPage,
      juzData: juzData,
      pageData: pageData,
    );
  }

  /// الحصول على رقم الصفحة من رقم السورة
  int? getPageForSurah(int surahNumber) {
    return _currentNavigationData?.getPageForSurah(surahNumber);
  }

  /// الحصول على رقم الصفحة من الآية
  int? getPageForAyah(int surahNumber, int ayahNumber) {
    return _currentNavigationData?.getPageForAyah(surahNumber, ayahNumber);
  }



  /// الحصول على معلومات الجزء
  JuzInfo? getJuzInfo(int juzNumber) {
    return _currentNavigationData?.getJuzInfo(juzNumber);
  }

  /// الحصول على معلومات الصفحة
  PageInfo? getPageInfo(int pageNumber) {
    return _currentNavigationData?.getPageInfo(pageNumber);
  }

  /// التحقق من صحة رقم الصفحة
  bool isValidPage(int page) {
    return _currentNavigationData?.isValidPage(page) ?? false;
  }

  /// الحصول على إجمالي عدد الصفحات
  int get totalPages {
    return _currentNavigationData?.totalPages ?? 604;
  }

  /// الحصول على قائمة الأجزاء
  List<JuzInfo> get juzList {
    if (_currentNavigationData == null) return [];
    return _currentNavigationData!.juzData.values.toList()
      ..sort((a, b) => a.number.compareTo(b.number));
  }

  /// ★ دالة ثابتة: تحديد السورة من رقم الصفحة بدون الاعتماد على بيانات محملة
  /// تعمل مع مصحف المدينة (604 صفحة) - وتُستخدم كـ fallback موثوق
  static int surahForPage(int page) {
    const surahStartPages = [
      1, 2, 50, 77, 106, 128, 151, 177, 187, 208,
      221, 235, 249, 255, 262, 267, 282, 293, 305, 312,
      322, 332, 342, 350, 359, 367, 377, 385, 396, 404,
      411, 415, 418, 428, 434, 440, 446, 453, 458, 467,
      477, 483, 489, 496, 499, 502, 507, 511, 515, 518,
      520, 523, 526, 528, 531, 534, 537, 542, 545, 549,
      551, 553, 554, 556, 558, 560, 562, 564, 566, 568,
      570, 572, 574, 575, 577, 578, 580, 582, 583, 585,
      586, 587, 587, 589, 590, 591, 591, 592, 593, 594,
      595, 595, 596, 596, 597, 597, 598, 598, 599, 599,
      600, 600, 601, 601, 601, 602, 602, 602, 603, 603,
      603, 604, 604, 604
    ];
    // البحث العكسي عن آخر سورة بدايتها <= الصفحة المطلوبة
    for (int i = surahStartPages.length - 1; i >= 0; i--) {
      if (surahStartPages[i] <= page) {
        return i + 1; // رقم السورة (1-indexed)
      }
    }
    return 1;
  }

  // ★★★ خارطة كاملة لـ 604 صفحة — مستخرجة مباشرة من quran_advanced.json
  // الصفحة → (رقم السورة، رقم أول آية) — دقة 100% — لا انتظار لقاعدة البيانات
  static const Map<int, (int, int)> _pageFirstAyah = {
    1: (1, 1), 2: (2, 1), 3: (2, 6), 4: (2, 17), 5: (2, 25),
    6: (2, 30), 7: (2, 38), 8: (2, 49), 9: (2, 58), 10: (2, 62),
    11: (2, 70), 12: (2, 77), 13: (2, 84), 14: (2, 89), 15: (2, 94),
    16: (2, 102), 17: (2, 106), 18: (2, 113), 19: (2, 120), 20: (2, 127),
    21: (2, 135), 22: (2, 142), 23: (2, 146), 24: (2, 154), 25: (2, 164),
    26: (2, 170), 27: (2, 177), 28: (2, 182), 29: (2, 187), 30: (2, 191),
    31: (2, 197), 32: (2, 203), 33: (2, 211), 34: (2, 216), 35: (2, 220),
    36: (2, 225), 37: (2, 231), 38: (2, 234), 39: (2, 238), 40: (2, 246),
    41: (2, 249), 42: (2, 253), 43: (2, 257), 44: (2, 260), 45: (2, 265),
    46: (2, 270), 47: (2, 275), 48: (2, 282), 49: (2, 283), 50: (3, 1),
    51: (3, 10), 52: (3, 16), 53: (3, 23), 54: (3, 30), 55: (3, 38),
    56: (3, 46), 57: (3, 53), 58: (3, 62), 59: (3, 71), 60: (3, 78),
    61: (3, 84), 62: (3, 92), 63: (3, 101), 64: (3, 109), 65: (3, 116),
    66: (3, 122), 67: (3, 133), 68: (3, 141), 69: (3, 149), 70: (3, 154),
    71: (3, 158), 72: (3, 166), 73: (3, 174), 74: (3, 181), 75: (3, 187),
    76: (3, 195), 77: (4, 1), 78: (4, 7), 79: (4, 12), 80: (4, 15),
    81: (4, 20), 82: (4, 24), 83: (4, 27), 84: (4, 34), 85: (4, 38),
    86: (4, 45), 87: (4, 52), 88: (4, 60), 89: (4, 66), 90: (4, 75),
    91: (4, 80), 92: (4, 87), 93: (4, 92), 94: (4, 95), 95: (4, 102),
    96: (4, 106), 97: (4, 114), 98: (4, 122), 99: (4, 128), 100: (4, 135),
    101: (4, 141), 102: (4, 148), 103: (4, 155), 104: (4, 163), 105: (4, 171),
    106: (4, 176), 107: (5, 3), 108: (5, 6), 109: (5, 10), 110: (5, 14),
    111: (5, 18), 112: (5, 24), 113: (5, 32), 114: (5, 37), 115: (5, 42),
    116: (5, 46), 117: (5, 51), 118: (5, 58), 119: (5, 65), 120: (5, 71),
    121: (5, 78), 122: (5, 84), 123: (5, 91), 124: (5, 96), 125: (5, 104),
    126: (5, 109), 127: (5, 114), 128: (6, 1), 129: (6, 9), 130: (6, 19),
    131: (6, 28), 132: (6, 36), 133: (6, 45), 134: (6, 53), 135: (6, 60),
    136: (6, 69), 137: (6, 74), 138: (6, 82), 139: (6, 91), 140: (6, 95),
    141: (6, 102), 142: (6, 111), 143: (6, 119), 144: (6, 125), 145: (6, 131),
    146: (6, 138), 147: (6, 143), 148: (6, 147), 149: (6, 152), 150: (6, 158),
    151: (7, 1), 152: (7, 12), 153: (7, 23), 154: (7, 31), 155: (7, 38),
    156: (7, 44), 157: (7, 52), 158: (7, 58), 159: (7, 68), 160: (7, 74),
    161: (7, 82), 162: (7, 88), 163: (7, 96), 164: (7, 105), 165: (7, 121),
    166: (7, 131), 167: (7, 138), 168: (7, 144), 169: (7, 150), 170: (7, 156),
    171: (7, 160), 172: (7, 164), 173: (7, 171), 174: (7, 179), 175: (7, 188),
    176: (7, 196), 177: (8, 1), 178: (8, 9), 179: (8, 17), 180: (8, 26),
    181: (8, 34), 182: (8, 41), 183: (8, 46), 184: (8, 53), 185: (8, 62),
    186: (8, 70), 187: (9, 1), 188: (9, 7), 189: (9, 14), 190: (9, 21),
    191: (9, 27), 192: (9, 32), 193: (9, 37), 194: (9, 41), 195: (9, 48),
    196: (9, 55), 197: (9, 62), 198: (9, 69), 199: (9, 73), 200: (9, 80),
    201: (9, 87), 202: (9, 94), 203: (9, 100), 204: (9, 107), 205: (9, 112),
    206: (9, 118), 207: (9, 123), 208: (10, 1), 209: (10, 7), 210: (10, 15),
    211: (10, 21), 212: (10, 26), 213: (10, 34), 214: (10, 43), 215: (10, 54),
    216: (10, 62), 217: (10, 71), 218: (10, 79), 219: (10, 89), 220: (10, 98),
    221: (10, 107), 222: (11, 6), 223: (11, 13), 224: (11, 20), 225: (11, 29),
    226: (11, 38), 227: (11, 46), 228: (11, 54), 229: (11, 63), 230: (11, 72),
    231: (11, 82), 232: (11, 89), 233: (11, 98), 234: (11, 109), 235: (11, 118),
    236: (12, 5), 237: (12, 15), 238: (12, 23), 239: (12, 31), 240: (12, 38),
    241: (12, 44), 242: (12, 53), 243: (12, 64), 244: (12, 70), 245: (12, 79),
    246: (12, 87), 247: (12, 96), 248: (12, 104), 249: (13, 1), 250: (13, 6),
    251: (13, 14), 252: (13, 19), 253: (13, 29), 254: (13, 35), 255: (13, 43),
    256: (14, 6), 257: (14, 11), 258: (14, 19), 259: (14, 25), 260: (14, 34),
    261: (14, 43), 262: (15, 1), 263: (15, 16), 264: (15, 32), 265: (15, 52),
    266: (15, 71), 267: (15, 91), 268: (16, 7), 269: (16, 15), 270: (16, 27),
    271: (16, 35), 272: (16, 43), 273: (16, 55), 274: (16, 65), 275: (16, 73),
    276: (16, 80), 277: (16, 88), 278: (16, 94), 279: (16, 103), 280: (16, 111),
    281: (16, 119), 282: (17, 1), 283: (17, 8), 284: (17, 18), 285: (17, 28),
    286: (17, 39), 287: (17, 50), 288: (17, 59), 289: (17, 67), 290: (17, 76),
    291: (17, 87), 292: (17, 97), 293: (17, 105), 294: (18, 5), 295: (18, 16),
    296: (18, 21), 297: (18, 28), 298: (18, 35), 299: (18, 46), 300: (18, 54),
    301: (18, 62), 302: (18, 75), 303: (18, 84), 304: (18, 98), 305: (19, 1),
    306: (19, 12), 307: (19, 26), 308: (19, 39), 309: (19, 52), 310: (19, 65),
    311: (19, 77), 312: (19, 96), 313: (20, 13), 314: (20, 38), 315: (20, 52),
    316: (20, 65), 317: (20, 77), 318: (20, 88), 319: (20, 99), 320: (20, 114),
    321: (20, 126), 322: (21, 1), 323: (21, 11), 324: (21, 25), 325: (21, 36),
    326: (21, 45), 327: (21, 58), 328: (21, 73), 329: (21, 82), 330: (21, 91),
    331: (21, 102), 332: (22, 1), 333: (22, 6), 334: (22, 16), 335: (22, 24),
    336: (22, 31), 337: (22, 39), 338: (22, 47), 339: (22, 56), 340: (22, 65),
    341: (22, 73), 342: (23, 1), 343: (23, 18), 344: (23, 28), 345: (23, 43),
    346: (23, 60), 347: (23, 75), 348: (23, 90), 349: (23, 105), 350: (24, 1),
    351: (24, 11), 352: (24, 21), 353: (24, 28), 354: (24, 32), 355: (24, 37),
    356: (24, 44), 357: (24, 54), 358: (24, 59), 359: (24, 62), 360: (25, 3),
    361: (25, 12), 362: (25, 21), 363: (25, 33), 364: (25, 44), 365: (25, 56),
    366: (25, 68), 367: (26, 1), 368: (26, 20), 369: (26, 40), 370: (26, 61),
    371: (26, 84), 372: (26, 112), 373: (26, 137), 374: (26, 160), 375: (26, 184),
    376: (26, 207), 377: (27, 1), 378: (27, 14), 379: (27, 23), 380: (27, 36),
    381: (27, 45), 382: (27, 56), 383: (27, 64), 384: (27, 77), 385: (27, 89),
    386: (28, 6), 387: (28, 14), 388: (28, 22), 389: (28, 29), 390: (28, 36),
    391: (28, 44), 392: (28, 51), 393: (28, 60), 394: (28, 71), 395: (28, 78),
    396: (28, 85), 397: (29, 7), 398: (29, 15), 399: (29, 24), 400: (29, 31),
    401: (29, 39), 402: (29, 46), 403: (29, 53), 404: (29, 64), 405: (30, 6),
    406: (30, 16), 407: (30, 25), 408: (30, 33), 409: (30, 42), 410: (30, 51),
    411: (31, 1), 412: (31, 12), 413: (31, 20), 414: (31, 29), 415: (32, 1),
    416: (32, 12), 417: (32, 21), 418: (33, 1), 419: (33, 7), 420: (33, 16),
    421: (33, 23), 422: (33, 31), 423: (33, 36), 424: (33, 44), 425: (33, 51),
    426: (33, 55), 427: (33, 63), 428: (34, 1), 429: (34, 8), 430: (34, 15),
    431: (34, 23), 432: (34, 32), 433: (34, 40), 434: (34, 49), 435: (35, 4),
    436: (35, 12), 437: (35, 19), 438: (35, 31), 439: (35, 39), 440: (35, 45),
    441: (36, 13), 442: (36, 28), 443: (36, 41), 444: (36, 55), 445: (36, 71),
    446: (37, 1), 447: (37, 25), 448: (37, 52), 449: (37, 77), 450: (37, 103),
    451: (37, 127), 452: (37, 154), 453: (38, 1), 454: (38, 17), 455: (38, 27),
    456: (38, 43), 457: (38, 62), 458: (38, 84), 459: (39, 6), 460: (39, 11),
    461: (39, 22), 462: (39, 32), 463: (39, 41), 464: (39, 48), 465: (39, 57),
    466: (39, 68), 467: (39, 75), 468: (40, 8), 469: (40, 17), 470: (40, 26),
    471: (40, 34), 472: (40, 41), 473: (40, 50), 474: (40, 59), 475: (40, 67),
    476: (40, 78), 477: (41, 1), 478: (41, 12), 479: (41, 21), 480: (41, 30),
    481: (41, 39), 482: (41, 47), 483: (42, 1), 484: (42, 11), 485: (42, 16),
    486: (42, 23), 487: (42, 32), 488: (42, 45), 489: (42, 52), 490: (43, 11),
    491: (43, 23), 492: (43, 34), 493: (43, 48), 494: (43, 61), 495: (43, 74),
    496: (44, 1), 497: (44, 19), 498: (44, 40), 499: (45, 1), 500: (45, 14),
    501: (45, 23), 502: (45, 33), 503: (46, 6), 504: (46, 15), 505: (46, 21),
    506: (46, 29), 507: (47, 1), 508: (47, 12), 509: (47, 20), 510: (47, 30),
    511: (48, 1), 512: (48, 10), 513: (48, 16), 514: (48, 24), 515: (48, 29),
    516: (49, 5), 517: (49, 12), 518: (50, 1), 519: (50, 16), 520: (50, 36),
    521: (51, 7), 522: (51, 31), 523: (51, 52), 524: (52, 15), 525: (52, 32),
    526: (53, 1), 527: (53, 27), 528: (53, 45), 529: (54, 7), 530: (54, 28),
    531: (54, 50), 532: (55, 19), 533: (55, 42), 534: (55, 70), 535: (56, 17),
    536: (56, 51), 537: (56, 77), 538: (57, 4), 539: (57, 12), 540: (57, 19),
    541: (57, 25), 542: (58, 1), 543: (58, 7), 544: (58, 12), 545: (58, 22),
    546: (59, 4), 547: (59, 10), 548: (59, 17), 549: (60, 1), 550: (60, 6),
    551: (60, 12), 552: (61, 6), 553: (62, 1), 554: (62, 9), 555: (63, 5),
    556: (64, 1), 557: (64, 10), 558: (65, 1), 559: (65, 6), 560: (66, 1),
    561: (66, 8), 562: (67, 1), 563: (67, 13), 564: (67, 27), 565: (68, 17),
    566: (68, 43), 567: (69, 9), 568: (69, 36), 569: (70, 11), 570: (70, 41),
    571: (71, 11), 572: (72, 1), 573: (72, 14), 574: (73, 1), 575: (73, 20),
    576: (74, 19), 577: (74, 48), 578: (75, 20), 579: (76, 6), 580: (76, 26),
    581: (77, 20), 582: (78, 1), 583: (78, 31), 584: (79, 17), 585: (80, 1),
    586: (80, 41), 587: (82, 1), 588: (83, 5), 589: (83, 34), 590: (84, 25),
    591: (86, 1), 592: (87, 11), 593: (88, 23), 594: (89, 23), 595: (90, 19),
    596: (92, 10), 597: (94, 3), 598: (96, 13), 599: (98, 6), 600: (100, 6),
    601: (103, 1), 602: (106, 1), 603: (109, 1), 604: (112, 1),
  };

  static int surahForPageFull(int page) => _pageFirstAyah[page]?.$1 ?? surahForPage(page);
  static int ayahForPageFull(int page)  => _pageFirstAyah[page]?.$2 ?? 1;

  // ★ البحث عن رقم الصفحة لسورة وآية محددتين — عكس _pageFirstAyah
  // يجد آخر صفحة بدأت بنفس السورة أو سورة سابقة وآيتها <= المطلوبة
  static int? pageForSurahAyah(int surah, int ayah) {
    int? result;
    // نمشي على الخارطة بالترتيب ونأخذ آخر صفحة تنطبق عليها الشرط
    for (int page = 1; page <= 604; page++) {
      final entry = _pageFirstAyah[page];
      if (entry == null) continue;
      final (pageSurah, pageAyah) = entry;

      if (pageSurah < surah) {
        // هذه الصفحة قبل السورة المطلوبة — ستبقى مرشحة
        result = page;
      } else if (pageSurah == surah && pageAyah <= ayah) {
        // هذه الصفحة تبدأ بنفس السورة وآيتها <= الآية المطلوبة
        result = page;
      } else {
        // تجاوزنا الهدف — الإجابة هي آخر قيمة صحيحة
        break;
      }
    }
    return result;
  }
}
